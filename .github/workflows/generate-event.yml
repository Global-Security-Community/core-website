name: Generate Event Page

on:
  repository_dispatch:
    types: [event-created]

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Generate event page
        run: |
          SLUG="${{ github.event.client_payload.event_slug }}"
          TITLE="${{ github.event.client_payload.event_title }}"
          DATE="${{ github.event.client_payload.event_date }}"
          END_DATE="${{ github.event.client_payload.event_end_date }}"
          LOCATION="${{ github.event.client_payload.event_location }}"
          DESCRIPTION="${{ github.event.client_payload.event_description }}"
          SESSIONIZE_ID="${{ github.event.client_payload.event_sessionize_id }}"
          REG_CAP="${{ github.event.client_payload.event_registration_cap }}"
          CHAPTER_SLUG="${{ github.event.client_payload.chapter_slug }}"

          mkdir -p "src/events/${SLUG}"

          cat > "src/events/${SLUG}/index.md" << 'FRONTMATTER'
          ---
          layout: event.njk
          FRONTMATTER

          # Use printf to safely write fields that may contain special characters
          # Replace newlines with ", " and escape double quotes for valid YAML
          safe_yaml() { echo "$1" | tr '\n' ',' | sed 's/,/, /g; s/, $//; s/"/\\"/g'; }
          {
            echo "title: \"$(safe_yaml "${TITLE}")\""
            echo "slug: \"${SLUG}\""
            echo "date: \"${DATE}\""
            echo "endDate: \"${END_DATE}\""
            echo "location: \"$(safe_yaml "${LOCATION}")\""
            echo "description: \"$(safe_yaml "${DESCRIPTION}")\""
            echo "sessionizeApiId: \"${SESSIONIZE_ID}\""
            echo "registrationCap: ${REG_CAP:-0}"
            echo "chapterSlug: \"${CHAPTER_SLUG}\""
            echo "---"
          } >> "src/events/${SLUG}/index.md"

          echo "Generated event page at src/events/${SLUG}/index.md"

      - name: Commit and push
        run: |
          git config user.name "GSC Chapter Generator[bot]"
          git config user.email "gsc-bot@globalsecurity.community"
          git add .
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "Add event page: ${{ github.event.client_payload.event_title }}

          Event: ${{ github.event.client_payload.event_title }}
          Date: ${{ github.event.client_payload.event_date }}
          Chapter: ${{ github.event.client_payload.chapter_slug }}

          Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"
          # Pull latest changes before pushing to avoid rejection
          git pull --rebase origin main
          git push
