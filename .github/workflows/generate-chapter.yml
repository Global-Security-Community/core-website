name: Generate Chapter Page

on:
  repository_dispatch:
    types: [chapter-approved]

permissions:
  contents: write

jobs:
  generate-chapter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Generate chapter page
        run: |
          CITY="${{ github.event.client_payload.chapter_city }}"
          COUNTRY="${{ github.event.client_payload.chapter_country }}"
          SLUG="${{ github.event.client_payload.chapter_slug }}"
          LEAD_NAME="${{ github.event.client_payload.lead_name }}"
          LEAD_BIO="${{ github.event.client_payload.lead_bio }}"
          DISCORD_CHANNEL_ID="${{ github.event.client_payload.discord_channel_id }}"
          DISCORD_GUILD_ID="${{ vars.DISCORD_GUILD_ID }}"

          # Parse second lead from JSON string
          SECOND_LEAD_JSON='${{ github.event.client_payload.second_lead }}'
          SECOND_LEAD_NAME=$(echo "${SECOND_LEAD_JSON}" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('name',''))" 2>/dev/null || echo "")
          SECOND_LEAD_BIO=$(echo "${SECOND_LEAD_JSON}" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('bio',''))" 2>/dev/null || echo "")
          SECOND_LEAD_EMAIL=$(echo "${SECOND_LEAD_JSON}" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d.get('email',''))" 2>/dev/null || echo "")

          mkdir -p "src/chapters/${SLUG}"

          # Build the YAML leads list with Gravatar email hashes
          LEAD_EMAIL="${{ github.event.client_payload.lead_email }}"
          LEAD_HASH=$(echo -n "${LEAD_EMAIL}" | tr '[:upper:]' '[:lower:]' | tr -d ' ' | md5sum | cut -d' ' -f1)

          # Sanitise bio text: escape quotes, remove problematic characters
          LEAD_BIO_SAFE=$(echo "${LEAD_BIO}" | sed 's/"/\\"/g' | tr -d '\n')

          # Build chapter page with proper YAML indentation
          {
            echo "---"
            echo "layout: chapter.njk"
            echo "title: \"Global Security ${CITY}\""
            echo "city: \"${CITY}\""
            echo "country: \"${COUNTRY}\""
            echo "tags: chapter"
            echo "discord_channel_id: \"${DISCORD_CHANNEL_ID}\""
            echo "discord_guild_id: \"${DISCORD_GUILD_ID}\""
            echo "leads:"
            echo "  - name: \"${LEAD_NAME}\""
            echo "    bio: \"${LEAD_BIO_SAFE}\""
            echo "    email_hash: \"${LEAD_HASH}\""
            if [ -n "${SECOND_LEAD_NAME}" ]; then
              SECOND_BIO_SAFE=$(echo "${SECOND_LEAD_BIO}" | sed 's/"/\\"/g' | tr -d '\n')
              SECOND_HASH=$(echo -n "${SECOND_LEAD_EMAIL}" | tr '[:upper:]' '[:lower:]' | tr -d ' ' | md5sum | cut -d' ' -f1)
              echo "  - name: \"${SECOND_LEAD_NAME}\""
              echo "    bio: \"${SECOND_BIO_SAFE}\""
              echo "    email_hash: \"${SECOND_HASH}\""
            fi
            echo "---"
          } > "src/chapters/${SLUG}/index.md"

          echo "Generated chapter page at src/chapters/${SLUG}/index.md"

      - name: Commit and push
        run: |
          CITY="${{ github.event.client_payload.chapter_city }}"
          SLUG="${{ github.event.client_payload.chapter_slug }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "src/chapters/${SLUG}/index.md"
          git commit -m "Add chapter page for ${CITY}

          Auto-generated from approved chapter application.

          Co-authored-by: Copilot <223556219+Copilot@users.noreply.github.com>"
          git push
          git push origin main:live-version-swa
